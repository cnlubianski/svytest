---
title: "Survey Weight Diagnostics with svytest"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Survey Weight Diagnostics with svytest}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Introduction

The **svytest** package provides formal diagnostic tests for assessing the role
of survey weights in regression modeling. Two complementary approaches are
implemented:

- **Difference-in-Coefficients test** (`diff_in_coef()`):  
  A Hausman–Pfeffermann style test comparing weighted and unweighted regression
  coefficients.

- **Weight-Association tests** (`wa_test()`):  
  A family of tests (DuMouchel–Duncan, Pfeffermann–Sverchkov, Wu–Fuller) that
  examine whether the survey weights are systematically associated with the
  response after conditioning on covariates.

Together, these tools help researchers evaluate whether survey weights are
ignorable or whether they materially affect inference.

# Example Dataset

The package includes a curated subset of the Consumer Expenditure (CE) survey
data, `svytestCE`, for demonstration purposes.

```{r setup, message = FALSE}
library(survey)
library(svytest)
data("svytestCE", package = "svytest")

des <- svydesign(ids = ~1, weights = ~FINLWT21, data = svytestCE)
```

# Difference-in-Coefficients Test

We first fit a survey-weigbhted regression of total quarterly expenditures (`TOTEXPCQ`) on household characteristics. 

```{r}
fit_svy <- svyglm(TOTEXPCQ ~ ROOMSQ + BATHRMQ + BEDROOMQ + FAM_SIZE + AGE,
                  design = des)

res_dc <- diff_in_coef(fit_svy, var_equal = FALSE, robust_type = "HC3")
print(res_dc)
```

The output reports the chi-squared statistic, degrees of freedom, and p-value. A small p-value indicates that weighted and unweighted coefficients differ significantly, suggesting weights are informative.

# Weight Association Tests

We can also test for direct associations between the weights and the response variable, conditional on covariates. For example, the DuMouchel–Duncan test:

```{r}
res_dd <- wa_test(fit_svy, type = "DD")
print(res_dd)
```

Other variants are available:

```{r}
wa_test(fit_svy, type = "PS1")
wa_test(fit_svy, type = "PS1q")
wa_test(fit_svy, type = "PS2")
wa_test(fit_svy, type = "PS2q")
wa_test(fit_svy, type = "WF")
```

# Tidyverse Integration

Both functions return S3 objects with `tidy()` and `glance()` methods for integration into pipelines:

```{r}
library(broom)

tidy(res_dc)
glance(res_dd)
```

# Conclusion

- Use `diff_in_coef()` to compare weighted vs. unweighted regression estimates.

- Use `wa_test()` to check whether weights are systematically associated with the outcome after conditioning on covariates.

